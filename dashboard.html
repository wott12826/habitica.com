<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Habitica - Dashboard</title>
  <link rel="shortcut icon" href="static/icons/favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles/responsive.css">
  <style>
    :root {
      --main-purple: #6c5ce7;
      --main-dark: #2d1436;
      --light-bg: #f8f9fa;
      --card-bg: #fff;
      --border: #e9ecef;
      --gray: #888;
      --radius: 14px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--light-bg);
      color: #222;
      min-height: 100vh;
    }
    .header {
      background: var(--main-purple);
      color: #fff;
      padding: 0 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .header-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      padding: 0 2rem;
      height: 64px;
    }
    .logo {
      font-weight: 800;
      font-size: 1.5rem;
      letter-spacing: 1px;
      margin-right: 2rem;
      color: #fff;
      text-decoration: none;
    }
    .nav {
      display: flex;
      gap: 2rem;
      flex: 1;
    }
    .nav a {
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      opacity: 0.9;
      transition: opacity 0.2s;
      position: relative;
    }
    .nav a.active, .nav a:hover {
      opacity: 1;
    }
    .nav a.active::after {
      content: '';
      display: block;
      height: 3px;
      background: #fff;
      border-radius: 2px;
      margin-top: 4px;
    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 1.2rem;
    }
    .header-actions .icon-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: 0.5rem;
    }
    .header-actions .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      color: var(--main-purple);
      font-weight: bold;
      margin-left: 0.5rem;
    }
    .dashboard {
      max-width: 1400px;
      margin: 2.5rem auto 0 auto;
      display: flex;
      gap: 2rem;
      padding: 0 2rem;
    }
    .profile {
      width: 260px;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      padding: 2rem 1.5rem 1.5rem 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 220px;
    }
    .profile .avatar {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }
    .profile .username {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 0.3rem;
      text-align: center;
    }
    .profile .userid {
      font-size: 0.85rem;
      color: var(--gray);
      margin-bottom: 0.7rem;
      text-align: center;
    }
    .profile .level {
      font-size: 0.95rem;
      color: var(--main-purple);
      font-weight: 600;
      margin-bottom: 1.2rem;
    }
    .profile .bar-label {
      font-size: 0.85rem;
      color: var(--gray);
      margin-bottom: 0.2rem;
    }
    .profile .bar {
      width: 100%;
      height: 12px;
      background: #eee;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      overflow: hidden;
    }
    .profile .bar-inner {
      height: 100%;
      border-radius: 6px;
      transition: width 0.3s ease;
    }
    .profile .bar-inner.xp {
      background: linear-gradient(90deg, #6c5ce7, #a29bfe);
    }
    .profile .bar-inner.hp {
      background: linear-gradient(90deg, #00b894, #00cec9);
    }
    .profile .bar-label span {
      float: right;
    }
    .profile .stats {
      display: flex;
      gap: 1.2rem;
      margin: 1.2rem 0 0.5rem 0;
      justify-content: center;
    }
    .profile .stats .stat {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 1.1rem;
      color: var(--main-purple);
      font-weight: 600;
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .dashboard-header {
      background: var(--main-purple);
      color: #fff;
      border-radius: var(--radius);
      padding: 1.5rem 2rem;
      margin-bottom: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .dashboard-header .title {
      font-size: 1.3rem;
      font-weight: 700;
    }
    .dashboard-header .desc {
      font-size: 1rem;
      opacity: 0.9;
    }
    .dashboard-header .cta-btn {
      background: #fff;
      color: var(--main-purple);
      border: none;
      border-radius: 8px;
      padding: 0.7rem 1.5rem;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .dashboard-header .cta-btn:hover {
      background: #f3f0ff;
    }
    .tasks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.5rem;
    }
    .task-col {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      padding: 1.2rem 1rem 1.5rem 1rem;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .task-col:last-child {
      min-width: 260px;
    }
    .task-col .col-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .task-col .col-title {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--main-purple);
    }
    .task-col .add-btn {
      background: none;
      border: none;
      color: var(--main-purple);
      font-size: 1.2rem;
      cursor: pointer;
      transition: color 0.2s;
    }
    .task-col .add-btn:hover {
      color: #a29bfe;
    }
    .task-list {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }
    .task-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 0.8rem 0.7rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.03);
      display: flex;
      align-items: flex-start;
      gap: 0.7rem;
      font-size: 0.98rem;
      border-left: 4px solid #6c5ce7;
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .task-card:hover {
      background: #f0f2f5;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .task-card.negative { border-left-color: #e17055; }
    .task-card .task-title { font-weight: 600; }
    .task-card .task-desc { color: #888; font-size: 0.93rem; margin-top: 0.2rem; }
    .task-card .task-actions {
      margin-left: auto;
      display: flex;
      gap: 0.5rem;
    }
    .task-card .habit-buttons {
      display: flex;
      gap: 0.3rem;
      margin-left: auto;
    }
    .task-card .habit-btn {
      background: none;
      border: 2px solid #ddd;
      border-radius: 6px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: bold;
      transition: all 0.2s ease;
    }
    .task-card .habit-btn.plus {
      color: #00b894;
      border-color: #00b894;
    }
    .task-card .habit-btn.plus:hover {
      background: #00b894;
      color: white;
    }
    .task-card .habit-btn.minus {
      color: #e17055;
      border-color: #e17055;
    }
    .task-card .habit-btn.minus:hover {
      background: #e17055;
      color: white;
    }
    .task-card .icon-btn {
      background: none;
      border: none;
      color: #888;
      font-size: 1rem;
      cursor: pointer;
      transition: color 0.2s;
    }
    .task-card .icon-btn:hover { color: #6c5ce7; }
    .empty-state {
      color: #bbb;
      text-align: center;
      margin-top: 2rem;
      font-size: 1rem;
    }
    .reward-list {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.7rem;
    }
    .reward-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 0.7rem 0.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.97rem;
      border: 1.5px solid #e9ecef;
      position: relative;
    }
    .reward-card .reward-icon {
      font-size: 1.3rem;
      margin-bottom: 0.3rem;
      color: #6c5ce7;
    }
    .reward-card .reward-cost {
      font-size: 0.95rem;
      color: #a29bfe;
      margin-top: 0.2rem;
    }
    .footer {
      background: #f8f9fa;
      color: #888;
      margin-top: 3rem;
      padding: 2.5rem 0 1.2rem 0;
      border-top: 1px solid #e9ecef;
    }
    .footer-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 2rem;
      padding: 0 2rem;
    }
    .footer-section h4 {
      color: var(--main-purple);
      margin-bottom: 0.7rem;
      font-size: 1.08rem;
    }
    .footer-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .footer-section ul li {
      margin-bottom: 0.5rem;
    }
    .footer-section ul li a {
      color: #888;
      text-decoration: none;
      transition: color 0.2s;
    }
    .footer-section ul li a:hover {
      color: #6c5ce7;
    }
    .footer-bottom {
      text-align: center;
      color: #bbb;
      font-size: 0.95rem;
      margin-top: 2rem;
    }
    @media (max-width: 1100px) {
      .dashboard { flex-direction: column; }
      .profile { width: 100%; flex-direction: row; gap: 2rem; justify-content: flex-start; }
      .main { width: 100%; }
      .rewards-special-list { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 900px) {
      .rewards-special-list { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .header-inner, .dashboard, .footer-inner { padding: 0 0.5rem; }
      .profile { flex-direction: column; align-items: center; }
      .rewards-special-list { grid-template-columns: 1fr; }
    }
  </style>
  <style>
 .modal-overlay {
  position: fixed;
  z-index: 10000;
  left: 0; top: 0; right: 0; bottom: 0;
  background: rgba(108, 92, 231, 0.85);
  display: none;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s;
}
.profile-modal {
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 8px 40px 0 rgba(44, 62, 80, 0.18);
  max-width: 370px;
  width: 100%;
  margin: 0 auto;
  padding: 32px 28px 24px 28px;
  position: relative;
  animation: modalPop 0.3s;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes modalPop { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.profile-modal .close-btn {
  position: absolute;
  right: 18px; top: 18px;
  background: none;
  border: none;
  font-size: 1.5rem;
  color: #aaa;
  cursor: pointer;
  transition: color 0.2s;
}
.profile-modal .close-btn:hover { color: #e17055; }
.profile-modal .modal-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: #6c5ce7;
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.avatar-group {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 18px;
}
.profile-avatar {
  width: 90px; height: 90px;
  border-radius: 50%;
  object-fit: cover;
  margin-bottom: 6px;
  border: 3px solid #eee;
  box-shadow: 0 2px 8px rgba(108,92,231,0.08);
  transition: box-shadow 0.2s, border 0.2s;
  cursor: pointer;
}
.avatar-label {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  position: relative;
}
.avatar-edit {
  font-size: 0.95rem;
  color: #6c5ce7;
  background: #f3f0ff;
  border-radius: 8px;
  padding: 2px 10px;
  margin-top: 2px;
  transition: background 0.2s, color 0.2s;
  cursor: pointer;
}
.avatar-label:hover .profile-avatar {
  border: 3px solid #6c5ce7;
  box-shadow: 0 4px 16px rgba(108,92,231,0.18);
}
.avatar-label:hover .avatar-edit {
  background: #6c5ce7;
  color: #fff;
}
.profile-modal .form-group {
  margin-bottom: 18px;
  text-align: left;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.profile-modal label {
  font-size: 0.98rem;
  color: #6c5ce7;
  font-weight: 600;
}
.profile-modal input[type="text"],
.profile-modal input[type="email"] {
  width: 100%;
  padding: 10px 14px;
  border-radius: 8px;
  border: 1.5px solid #d1d8e6;
  font-size: 1.05rem;
  background: #f6f7fb;
  color: #222;
  margin-top: 2px;
  box-shadow: 0 1px 2px rgba(108,92,231,0.04);
  transition: border 0.2s, box-shadow 0.2s, background 0.2s;
}

.profile-modal input[type="text"]:focus,
.profile-modal input[type="email"]:focus {
  border: 1.5px solid #6c5ce7;
  background: #fff;
  outline: none;
  box-shadow: 0 2px 8px rgba(108,92,231,0.10);
}

.profile-modal input[type="email"]:disabled {
  color: #888;
  background: #f1f2f6;
  border-style: dashed;
  opacity: 1;
}
.profile-modal .form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 8px;
}
.profile-modal .btn {
  padding: 9px 22px;
  border-radius: 8px;
  border: none;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}
.profile-modal .btn-primary {
  background: #6c5ce7;
  color: #fff;
}
.profile-modal .btn-primary:hover {
  background: #4834d4;
}
.profile-modal .btn-secondary {
  background: #f1f2f6;
  color: #636e72;
}
.profile-modal .btn-secondary:hover {
  background: #dfe4ea;
  color: #2d3436;
}
    .modal-overlay.active {
      display: flex;
    }
    .party-modal, .habit-modal {
      background: #fff;
      border-radius: 22px;
      box-shadow: 0 12px 48px 0 rgba(108,92,231,0.18), 0 2px 8px 0 rgba(76,56,133,0.10);
      max-width: 420px;
      width: 100%;
      padding: 2.5rem 2rem 2.2rem 2rem;
      position: relative;
      text-align: center;
      animation: fadeIn 0.5s cubic-bezier(.4,0,.2,1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .habit-modal {
      max-width: 500px;
      text-align: left;
      background: linear-gradient(135deg, #f8f9fa 80%, #e9e6fa 100%);
      box-shadow: 0 12px 48px 0 rgba(108,92,231,0.18), 0 2px 8px 0 rgba(76,56,133,0.10);
      border-radius: 22px;
      padding: 0;
      position: relative;
      animation: fadeIn 0.5s cubic-bezier(.4,0,.2,1);
      overflow: hidden;
    }
    .habit-modal .modal-content {
      align-items: stretch;
      gap: 1.2rem;
      padding: 2.5rem 2.2rem 2.2rem 2.2rem;
      background: transparent;
    }
    .habit-modal .modal-title {
      text-align: center;
      margin-bottom: 1.2rem;
      font-size: 1.35rem;
      font-weight: 800;
      color: #6c5ce7;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.7rem;
    }
    .habit-modal .modal-title::before {
      content: '\f303';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      font-size: 1.2em;
      color: #a29bfe;
      margin-right: 0.3em;
      display: inline-block;
    }
    .habit-modal .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1.1rem;
    }
    .habit-modal .form-group label {
      font-weight: 700;
      color: #5a4fd8;
      font-size: 1.01rem;
      margin-bottom: 0.2rem;
    }
    .habit-modal .form-group input,
    .habit-modal .form-group textarea,
    .habit-modal .form-group select {
      padding: 1rem;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 1.08rem;
      background: #fff;
      transition: border-color 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 4px rgba(108,92,231,0.04);
    }
    .habit-modal .form-group input:focus,
    .habit-modal .form-group textarea:focus,
    .habit-modal .form-group select:focus {
      outline: none;
      border-color: #a29bfe;
      box-shadow: 0 2px 8px rgba(108,92,231,0.10);
    }
    .habit-modal .form-group textarea {
      resize: vertical;
      min-height: 90px;
    }
    .habit-modal .checkbox-group {
      display: flex;
      gap: 1.2rem;
      margin-top: 0.5rem;
    }
    .habit-modal .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.01rem;
      color: #6c5ce7;
    }
    .habit-modal .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #6c5ce7;
      border-radius: 6px;
    }
    .habit-modal .modal-actions {
      display: flex;
      gap: 1.2rem;
      margin-top: 1.5rem;
      border-top: 1px solid #ececec;
      padding-top: 1.2rem;
    }
    .habit-modal .btn {
      flex: 1;
      padding: 1rem 0.5rem;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1.08rem;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 4px rgba(108,92,231,0.04);
    }
    .habit-modal .btn-primary {
      background: linear-gradient(90deg, #6c5ce7 0%, #a29bfe 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(108,92,231,0.10);
    }
    .habit-modal .btn-primary:hover {
      background: linear-gradient(90deg, #5a4fd8 0%, #6c5ce7 100%);
    }
    .habit-modal .btn-secondary {
      background: #f8f9fa;
      color: #6c5ce7;
      border: 2px solid #e9ecef;
    }
    .habit-modal .btn-secondary:hover {
      background: #ececec;
      color: #5a4fd8;
    }
    .habit-modal .btn-danger {
      background: linear-gradient(90deg, #e17055 0%, #ffb199 100%);
      color: white;
    }
    .habit-modal .btn-danger:hover {
      background: #d15a3f;
    }
    .habit-modal .close-btn {
      position: absolute;
      top: 18px;
      right: 18px;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #bbb;
      cursor: pointer;
      transition: color 0.2s;
      z-index: 2;
    }
    .habit-modal .close-btn:hover {
      color: #6c5ce7;
    }
    @media (max-width: 500px) {
      .habit-modal .modal-content { padding: 1.2rem 0.5rem; }
      .habit-modal { max-width: 98vw; }
      .habit-modal .modal-actions { flex-direction: column; }
    }
    .party-modal .party-img {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-bottom: 1.2rem;
    }
    .party-modal .party-img img {
      max-width: 220px;
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(108,92,231,0.10);
      background: #e9e6fa;
    }
    .modal .modal-title {
      font-size: 1.18rem;
      font-weight: 800;
      color: #6c5ce7;
      margin-bottom: 0.5rem;
    }
    .habit-modal .modal-title {
      text-align: center;
      margin-bottom: 1rem;
    }
    .modal .modal-desc {
      color: #444;
      font-size: 1.01rem;
      margin-bottom: 1.1rem;
    }
    .party-modal .party-btn {
      display: block;
      width: 100%;
      margin: 0.7rem 0 0.2rem 0;
      padding: 1.1rem 0;
      font-size: 1.13rem;
      font-weight: 700;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: linear-gradient(90deg, #6c5ce7 0%, #a29bfe 100%);
      color: #fff;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px rgba(108,92,231,0.10);
      letter-spacing: 0.5px;
    }
    .party-modal .party-btn:hover {
      background: linear-gradient(90deg, #5a4fd8 0%, #6c5ce7 100%);
    }
    .party-modal .divider {
      width: 100%;
      height: 1px;
      background: #ececec;
      margin: 1.2rem 0 1.2rem 0;
    }
    .party-modal .group-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.7rem;
      width: 100%;
    }
    .party-modal .group-img {
      width: 90px;
      margin-bottom: 0.2rem;
    }
    .party-modal .group-img img {
      width: 100%;
      border-radius: 8px;
      background: #e9e6fa;
      box-shadow: 0 1px 6px rgba(108,92,231,0.08);
    }
    .party-modal .group-title {
      font-size: 1.08rem;
      font-weight: 700;
      color: #6c5ce7;
      margin-bottom: 0.2rem;
      margin-top: 0.2rem;
    }
    .party-modal .group-desc {
      color: #444;
      font-size: 0.99rem;
      margin-bottom: 0.7rem;
      margin-top: 0.1rem;
    }
    .party-modal .group-btn {
      display: block;
      width: 100%;
      margin: 0.2rem 0 0.2rem 0;
      padding: 0.9rem 0;
      font-size: 1.08rem;
      font-weight: 700;
      border-radius: 10px;
      border: 2px solid #a29bfe;
      cursor: pointer;
      background: #f3f0ff;
      color: #6c5ce7;
      transition: background 0.2s, color 0.2s;
      letter-spacing: 0.2px;
    }
    .party-modal .group-btn:hover {
      background: #e9e6fa;
      color: #5a4fd8;
    }
    .party-modal .close-btn {
      position: absolute;
      top: 18px;
      right: 18px;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #bbb;
      cursor: pointer;
      transition: color 0.2s;
      z-index: 2;
    }
    .party-modal .close-btn:hover {
      color: #6c5ce7;
    }
    @media (max-width: 600px) {
      .party-modal { max-width: 98vw; padding: 1.2rem 0.5rem; }
      .party-modal .modal-content { padding: 0; }
      .party-modal .party-img img { max-width: 140px; }
      .party-modal .group-img { width: 60px; }
    }
  </style>
  <style>
    .rewards-block {
      background: #f8f9fa;
      border-radius: 18px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      padding: 1.5rem 1.5rem 1.5rem 1.5rem;
      margin-top: 0.5rem;
      overflow: hidden;
      box-sizing: border-box;
      width: 100%;
      max-width: 100%;
    }
    .rewards-tabs {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1.1rem;
      border-bottom: 2px solid #ececec;
    }
    .rewards-tab {
      background: none;
      border: none;
      font-weight: 700;
      font-size: 1.05rem;
      color: #6c5ce7;
      padding: 0.7rem 0.5rem 0.5rem 0.5rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: border-color 0.2s, color 0.2s;
    }
    .rewards-tab.active {
      color: #2d1436;
      border-bottom: 3px solid #6c5ce7;
    }
    .rewards-add-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.2rem;
    }
    .rewards-add-input {
      flex: 1;
      padding: 0.7rem 1rem;
      border-radius: 8px;
      border: 2px solid #e9ecef;
      font-size: 1rem;
      background: #fff;
      transition: border-color 0.2s;
    }
    .rewards-add-input:focus {
      border-color: #6c5ce7;
      outline: none;
    }
    .rewards-add-btn {
      background: #6c5ce7;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.2rem;
      padding: 0 1.1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .rewards-add-btn:hover {
      background: #a29bfe;
    }
    .rewards-user-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1.2rem;
      margin-bottom: 1.2rem;
    }
    .rewards-self-block {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(108,92,231,0.04);
      padding: 0.8rem 1rem 0.8rem 1rem;
      margin-bottom: 1.1rem;
    }
    .rewards-self-title {
      font-weight: 700;
      color: #6c5ce7;
      font-size: 1.08rem;
      margin-bottom: 0.2rem;
    }
    .rewards-self-desc {
      color: #888;
      font-size: 0.97rem;
    }
    .rewards-special-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1.2rem;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    .reward-card {
      min-width: 140px;
      width: 100%;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 0.7rem 0.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.97rem;
      border: 1.5px solid #e9ecef;
      position: relative;
    }
    .reward-card .reward-icon {
      font-size: 1.3rem;
      margin-bottom: 0.3rem;
      color: #6c5ce7;
    }
    .reward-card .reward-cost {
      font-size: 0.95rem;
      color: #a29bfe;
      margin-top: 0.2rem;
    }
    .reward-card .reward-dot {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      background: #a29bfe;
      border-radius: 50%;
    }
    @media (max-width: 900px) {
      .rewards-user-list { grid-template-columns: repeat(2, 1fr); }
      .rewards-special-list { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 600px) {
      .rewards-user-list { grid-template-columns: 1fr; }
      .rewards-special-list { grid-template-columns: 1fr; }
    }
  </style>
  <style>
    .habits-block {
      margin-top: 0.5rem;
    }
    .habits-tabs {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1.1rem;
      border-bottom: 2px solid #ececec;
    }
    .habits-tab {
      background: none;
      border: none;
      font-weight: 700;
      font-size: 1.05rem;
      color: #6c5ce7;
      padding: 0.7rem 0.5rem 0.5rem 0.5rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: border-color 0.2s, color 0.2s;
    }
    .habits-tab.active {
      color: #2d1436;
      border-bottom: 3px solid #6c5ce7;
    }
  </style>
  <style>
    .dailies-block {
      margin-top: 0.5rem;
    }
    .dailies-tabs {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1.1rem;
      border-bottom: 2px solid #ececec;
    }
    .dailies-tab {
      background: none;
      border: none;
      font-weight: 700;
      font-size: 1.05rem;
      color: #6c5ce7;
      padding: 0.7rem 0.5rem 0.5rem 0.5rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: border-color 0.2s, color 0.2s;
    }
    .dailies-tab.active {
      color: #2d1436;
      border-bottom: 3px solid #6c5ce7;
    }
  </style>
  <style>
    .todos-block {
      margin-top: 0.5rem;
    }
    .todos-tabs {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1.1rem;
      border-bottom: 2px solid #ececec;
    }
    .todos-tab {
      background: none;
      border: none;
      font-weight: 700;
      font-size: 1.05rem;
      color: #6c5ce7;
      padding: 0.7rem 0.5rem 0.5rem 0.5rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: border-color 0.2s, color 0.2s;
    }
    .todos-tab.active {
      color: #2d1436;
      border-bottom: 3px solid #6c5ce7;
    }
  </style>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a href="dashboard.html" class="logo">Habitica</a>
      <nav class="nav">
        <a href="dashboard.html" class="active">Tasks</a>
        <a href="inventory.html">Inventory</a>
        <a href="market.html">Shops</a>
        <a href="#" id="openPartyModal">Party</a>
        <a href="group-plans.html">Guild</a>
        <a href="challenges.html">Challenges</a>
      </nav>
      <div class="header-actions">
        <span class="stat"><i class="fa-solid fa-gem"></i> <span id="gems">0</span></span>
        <span class="stat"><i class="fa-solid fa-coins"></i> <span id="coins">0</span></span>
        <button class="icon-btn"><i class="fa-solid fa-bell"></i></button>
<button class="icon-btn"><i class="fa-solid fa-cog"></i></button>        
<span class="avatar"><i class="fa-solid fa-user"></i></span>
      </div>
    </div>
  </header>
  <div class="dashboard">
    <aside class="profile">
      <div class="avatar" id="sidebarAvatar"><i class="fa-solid fa-user"></i></div>      <div>
        <div class="username" id="userDisplayName">Guest</div>
        <div class="userid" id="userEmail">guest@habitica.com</div>
        <div class="level">Level <span id="level">1</span> Warrior</div>
        <div class="bar-label">XP <span id="xpDisplay">50 / 100</span></div>
        <div class="bar"><div class="bar-inner xp" id="xpBar"></div></div>
        <div class="bar-label">HP <span id="hpDisplay">50 / 50</span></div>
        <div class="bar"><div class="bar-inner hp" id="hpBar"></div></div>
        <div class="stats">
          <span class="stat"><i class="fa-solid fa-gem"></i> <span id="gemsProfile">0</span></span>
          <span class="stat"><i class="fa-solid fa-coins"></i> <span id="coinsProfile">0</span></span>
        </div>
      </div>
    </aside>
    <main class="main">
      <div class="dashboard-header">
        <div>
          <div class="title">Defeat monsters with friends</div>
          <div class="desc">Create your own party or join an existing one to complete tasks and boost motivation!</div>
        </div>
        <button class="cta-btn">Start</button>
      </div>
      <div class="tasks-grid">
        <!-- Habits -->
        <div class="task-col">
          <div class="col-header">
            <span class="col-title">Habits</span>
            <button class="add-btn" title="Add Habit" onclick="openHabitModal()"><i class="fa-solid fa-plus"></i></button>
          </div>
          <div class="habits-block">
            <div class="habits-tabs">
              <button class="habits-tab active" id="tabHabitsAll" onclick="switchHabitsTab('all')">All</button>
              <button class="habits-tab" id="tabHabitsWeak" onclick="switchHabitsTab('weak')">Weak</button>
              <button class="habits-tab" id="tabHabitsStrong" onclick="switchHabitsTab('strong')">Strong</button>
            </div>
            <div class="task-list" id="habitsList"></div>
          </div>
        </div>
        <!-- Dailies -->
        <div class="task-col">
          <div class="col-header">
            <span class="col-title">Dailies</span>
            <button class="add-btn" title="Add Daily" onclick="openDailyModal()"><i class="fa-solid fa-plus"></i></button>
          </div>
          <div class="dailies-block">
            <div class="dailies-tabs">
              <button class="dailies-tab active" id="tabDailiesAll" onclick="switchDailiesTab('all')">All</button>
              <button class="dailies-tab" id="tabDailiesCurrent" onclick="switchDailiesTab('current')">Current</button>
              <button class="dailies-tab" id="tabDailiesOther" onclick="switchDailiesTab('other')">Other</button>
            </div>
            <div class="task-list" id="dailiesList"></div>
          </div>
        </div>
        <!-- To-Dos -->
        <div class="task-col">
          <div class="col-header">
            <span class="col-title">To-Dos</span>
            <button class="add-btn" title="Add To-Do" onclick="openTodoModal()"><i class="fa-solid fa-plus"></i></button>
          </div>
          <div class="todos-block">
            <div class="todos-tabs">
              <button class="todos-tab active" id="tabTodosActive" onclick="switchTodosTab('active')">Active</button>
              <button class="todos-tab" id="tabTodosDated" onclick="switchTodosTab('dated')">With Date</button>
              <button class="todos-tab" id="tabTodosDone" onclick="switchTodosTab('done')">Done</button>
            </div>
            <div class="task-list" id="todosList"></div>
          </div>
        </div>
        <!-- Rewards -->
        <div class="task-col">
          <div class="col-header">
            <span class="col-title">Rewards</span>
            <button class="add-btn" title="Add Reward" onclick="openRewardModal()"><i class="fa-solid fa-plus"></i></button>
          </div>
          <div class="rewards-block">
            <div class="rewards-tabs">
              <button class="rewards-tab active" id="tabAll" onclick="switchRewardsTab('all')">All</button>
              <button class="rewards-tab" id="tabSeasonal" onclick="switchRewardsTab('seasonal')">Seasonal</button>
              <button class="rewards-tab" id="tabDelayed" onclick="switchRewardsTab('delayed')">Delayed</button>
            </div>

            <div class="rewards-user-list" id="rewardsList"></div>
            <div class="rewards-self-block">
              <div class="rewards-self-title">Reward Yourself</div>
              <div class="rewards-self-desc">Watch TV, play games, eat treats, it's up to you!</div>
            </div>
            <div class="rewards-special-list" id="specialRewardsList"></div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <footer class="footer">
    <div class="footer-inner">
      <div class="footer-section">
        <h4>Product</h4>
        <ul>
          <li><a href="#">iOS App</a></li>
          <li><a href="#">Android App</a></li>
          <li><a href="#">Group Plans</a></li>
          <li><a href="#">How it works</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>Company</h4>
        <ul>
          <li><a href="#">Contact</a></li>
          <li><a href="#">Press</a></li>
          <li><a href="#">Blog</a></li>
          <li><a href="#">News</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>Community</h4>
        <ul>
          <li><a href="#">Community Guidelines</a></li>
          <li><a href="#">Hall of Heroes</a></li>
          <li><a href="#">Contribute</a></li>
          <li><a href="#">Translate Habitica</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>Support</h4>
        <ul>
          <li><a href="#">FAQ</a></li>
          <li><a href="#">Report a Problem</a></li>
          <li><a href="#">Suggest a Feature</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>Developers</h4>
        <ul>
          <li><a href="#">API v3</a></li>
          <li><a href="#">Data Display</a></li>
          <li><a href="#">Blacksmiths Guide</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      &copy; 2025 Habitica. All rights reserved.
    </div>
  </footer>
  
  <!-- Party Modal -->
  <div class="modal-overlay" id="partyModal">
    <div class="party-modal">
      <button class="close-btn" onclick="closeModal('partyModal')" title="Close">&times;</button>
      <div class="modal-content">
        <div class="party-img">
          <img src="static/icons/group@3x-BRelOOPS.png" alt="Party Pixel Art">
        </div>
        <div class="modal-title">Play Habitica in a Party!</div>
        <div class="modal-desc">Go on amazing Quests with friends or solo. Battle monsters, create challenges, and help each other stay accountable with a party!</div>
        <button class="party-btn">Create Party</button>
        <div class="divider"></div>
        <div class="group-block">
          <div class="group-img">
            <img src="static/icons/party-BBgVse-q.png" alt="Group Pixel Art">
          </div>
          <div class="group-title">Looking for a Party?</div>
          <div class="group-desc">Want to join a party but don't know other players? Let party leaders know you want to get invited!</div>
          <button class="group-btn">Find Party</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Habit Edit Modal -->
  <div class="modal-overlay" id="habitModal">
    <div class="habit-modal">
      <button class="close-btn" onclick="closeModal('habitModal')" title="Close">&times;</button>
      <div class="modal-content">
        <div class="modal-title">Edit Habit</div>
        <form id="habitForm">
          <div class="form-group">
            <label for="habitTitle">Title</label>
            <input type="text" id="habitTitle" name="title" placeholder="Enter habit title" required>
          </div>
          <div class="form-group">
            <label for="habitNotes">Notes</label>
            <textarea id="habitNotes" name="notes" placeholder="Add notes about this habit"></textarea>
          </div>
          <div class="form-group">
            <label for="habitDifficulty">Difficulty</label>
            <select id="habitDifficulty" name="difficulty">
              <option value="trivial">Trivial</option>
              <option value="easy">Easy</option>
              <option value="medium" selected>Medium</option>
              <option value="hard">Hard</option>
            </select>
          </div>
          <div class="form-group">
            <label for="habitTags">Tags</label>
            <input type="text" id="habitTags" name="tags" placeholder="Enter tags separated by commas">
          </div>
          <div class="form-group">
            <label>Habit Type</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="positiveHabit" name="positive" checked>
                <label for="positiveHabit">Positive habit (+XP)</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="negativeHabit" name="negative">
                <label for="negativeHabit">Negative habit (-HP)</label>
              </div>
            </div>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-danger" onclick="deleteHabit()">Delete</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('habitModal')">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Daily Edit Modal -->
  <div class="modal-overlay" id="dailyModal">
    <div class="habit-modal">
      <button class="close-btn" onclick="closeModal('dailyModal')" title="Close">&times;</button>
      <div class="modal-content">
        <div class="modal-title">Edit Daily</div>
        <form id="dailyForm">
          <div class="form-group">
            <label for="dailyTitle">Title</label>
            <input type="text" id="dailyTitle" name="title" placeholder="Enter daily title" required>
          </div>
          <div class="form-group">
            <label for="dailyNotes">Notes</label>
            <textarea id="dailyNotes" name="notes" placeholder="Add notes about this daily"></textarea>
          </div>
          <div class="form-group">
            <label for="dailyDifficulty">Difficulty</label>
            <select id="dailyDifficulty" name="difficulty">
              <option value="trivial">Trivial</option>
              <option value="easy">Easy</option>
              <option value="medium" selected>Medium</option>
              <option value="hard">Hard</option>
            </select>
          </div>
          <div class="form-group">
            <label for="dailyTags">Tags</label>
            <input type="text" id="dailyTags" name="tags" placeholder="Enter tags separated by commas">
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-danger" onclick="deleteDaily()">Delete</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('dailyModal')">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- To-Do Edit Modal -->
  <div class="modal-overlay" id="todoModal">
    <div class="habit-modal">
      <button class="close-btn" onclick="closeModal('todoModal')" title="Close">&times;</button>
      <div class="modal-content">
        <div class="modal-title">Edit To-Do</div>
        <form id="todoForm">
          <div class="form-group">
            <label for="todoTitle">Title</label>
            <input type="text" id="todoTitle" name="title" placeholder="Enter to-do title" required>
          </div>
          <div class="form-group">
            <label for="todoNotes">Notes</label>
            <textarea id="todoNotes" name="notes" placeholder="Add notes about this to-do"></textarea>
          </div>
          <div class="form-group">
            <label for="todoDifficulty">Difficulty</label>
            <select id="todoDifficulty" name="difficulty">
              <option value="trivial">Trivial</option>
              <option value="easy">Easy</option>
              <option value="medium" selected>Medium</option>
              <option value="hard">Hard</option>
            </select>
          </div>
          <div class="form-group">
            <label for="todoTags">Tags</label>
            <input type="text" id="todoTags" name="tags" placeholder="Enter tags separated by commas">
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-danger" onclick="deleteTodo()">Delete</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('todoModal')">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Reward Edit Modal -->
  <div class="modal-overlay" id="rewardModal">
    <div class="habit-modal">
      <button class="close-btn" onclick="closeModal('rewardModal')" title="Close">&times;</button>
      <div class="modal-content">
        <div class="modal-title">Edit Reward</div>
        <form id="rewardForm">
          <div class="form-group">
            <label for="rewardTitle">Title</label>
            <input type="text" id="rewardTitle" name="title" placeholder="Enter reward title" required>
          </div>
          <div class="form-group">
            <label for="rewardNotes">Notes</label>
            <textarea id="rewardNotes" name="notes" placeholder="Add notes about this reward"></textarea>
          </div>
          <div class="form-group">
            <label for="rewardPrice">Price</label>
            <input type="number" id="rewardPrice" name="price" placeholder="Enter reward price" required>
          </div>
          <div class="form-group">
            <label for="rewardTags">Tags</label>
            <input type="text" id="rewardTags" name="tags" placeholder="Enter tags separated by commas">
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-danger" onclick="deleteReward()">Delete</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('rewardModal')">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Special Reward Modal -->
  <div class="modal-overlay" id="specialRewardModal">
    <div class="habit-modal">
      <button class="close-btn" onclick="closeModal('specialRewardModal')" title="Close">&times;</button>
      <div class="modal-content">
        <div class="modal-title">Special Reward</div>
        <div class="reward-icon">
          <img id="specialRewardIcon" src="" alt="Special Reward Icon">
        </div>
        <div class="reward-title" id="specialRewardTitle"></div>
        <div class="reward-desc" id="specialRewardDesc"></div>
        <div class="reward-price" id="specialRewardPrice"></div>
        <div class="reward-stats">
          <div>Strength: <span id="specialRewardStr">0</span></div>
          <div>Intelligence: <span id="specialRewardInt">0</span></div>
          <div>Constitution: <span id="specialRewardCon">0</span></div>
          <div>Perception: <span id="specialRewardPer">0</span></div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal('specialRewardModal')">Close</button>
          <button type="button" class="btn btn-primary" onclick="buySpecialReward()">Buy</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Game state
    let gameState = {
      xp: 50,
      maxXp: 100,
      hp: 50,
      maxHp: 50,
      level: 1,
      gems: 0,
      coins: 0,
      habits: [
        {
          id: 1,
          title: "Click to mark this as a bad habit you want to break",
          notes: "Or edit or delete this habit",
          difficulty: "medium",
          tags: "",
          positive: false,
          negative: true,
          lastPlusClick: 0,
          lastMinusClick: 0
        },
        {
          id: 2,
          title: "Add a Habit in Habitica",
          notes: "Either a positive, negative, or both habit",
          difficulty: "medium",
          tags: "",
          positive: true,
          negative: false,
          lastPlusClick: 0,
          lastMinusClick: 0
        }
      ],
      dailies: [
        {
          id: 1,
          title: "Do morning exercise",
          notes: "10 push-ups or 5 min stretching",
          difficulty: "easy",
          tags: "health,fitness",
          completed: false
        }
      ],
      todos: [
        {
          id: 1,
          title: "Join Habitica (Check me off!)",
          notes: "You can complete, edit, or delete this task",
          difficulty: "easy",
          tags: "onboarding",
          completed: false
        }
      ],
      rewards: [
        {
          id: 1,
          title: "Watch TV",
          notes: "Relax and watch your favorite show",
          price: 10,
          tags: "relax"
        }
      ],
      specialRewards: [
        {
          id: 101,
          title: "Spear of Destiny",
          description: "A legendary spear that increases your Strength and Perception.",
          icon: "static/icons/imgi_2_shop_weapon_special_summer2025Warrior.png",
          price: 90,
          bonuses: { str: 10, int: 0, con: 0, per: 7 },
          stats: { str: 10, int: 0, con: 0, per: 7 },
          classBonus: 4.5
        },
        {
          id: 102,
          title: "Pink Bow",
          description: "A cute bow that boosts your Intelligence and Perception.",
          icon: "static/icons/imgi_3_shop_armor_special_summer2025Warrior.png",
          price: 90,
          bonuses: { str: 0, int: 8, con: 0, per: 8 },
          stats: { str: 0, int: 8, con: 0, per: 8 },
          classBonus: 3.5
        },
        {
          id: 103,
          title: "Scallop Helm",
          description: "Impenetrable and perfectly pointy, this helmet will even protect you from starfish. Increases Strength by 9. Limited Edition Summer 2025 Gear.",
          icon: "static/icons/imgi_4_shop_head_special_summer2025Warrior.png",
          price: 60,
          bonuses: { str: 13, int: 0, con: 2, per: 0 },
          stats: { str: 9, int: 0, con: 2, per: 0 },
          classBonus: 4.5
        },
        {
          id: 104,
          title: "Blue Shell",
          description: "A rare shell that increases your Constitution and Perception.",
          icon: "static/icons/imgi_5_shop_shield_special_summer2025Warrior.png",
          price: 70,
          bonuses: { str: 0, int: 0, con: 10, per: 5 },
          stats: { str: 0, int: 0, con: 10, per: 5 },
          classBonus: 2.5
        },
        {
          id: 105,
          title: "Magic Wand",
          description: "A wand that boosts your Intelligence.",
          icon: "static/icons/imgi_6_shop_weapon_warrior_0.png",
          price: 1,
          bonuses: { str: 0, int: 12, con: 0, per: 0 },
          stats: { str: 0, int: 12, con: 0, per: 0 },
          classBonus: 2.0
        },
        {
          id: 106,
          title: "Crab Mount",
          description: "A sturdy crab mount that increases your Constitution.",
          icon: "static/icons/imgi_7_shop_armor_warrior_1.png",
          price: 30,
          bonuses: { str: 0, int: 0, con: 8, per: 0 },
          stats: { str: 0, int: 0, con: 8, per: 0 },
          classBonus: 1.5
        },
        {
          id: 107,
          title: "Wooden Shield",
          description: "A simple shield that increases your Constitution.",
          icon: "static/icons/imgi_8_shop_shield_warrior_1.png",
          price: 20,
          bonuses: { str: 0, int: 0, con: 6, per: 0 },
          stats: { str: 0, int: 0, con: 6, per: 0 },
          classBonus: 1.0
        },
        {
          id: 108,
          title: "Viking Helm",
          description: "A horned helm that increases Strength and Constitution.",
          icon: "static/icons/imgi_9_shop_head_warrior_1.png",
          price: 15,
          bonuses: { str: 5, int: 0, con: 5, per: 0 },
          stats: { str: 5, int: 0, con: 5, per: 0 },
          classBonus: 1.0
        },
        {
          id: 109,
          title: "Potion of Wisdom",
          description: "A potion that increases your Intelligence.",
          icon: "static/icons/imgi_10_shop_potion.png",
          price: 25,
          bonuses: { str: 0, int: 10, con: 0, per: 0 },
          stats: { str: 0, int: 10, con: 0, per: 0 },
          classBonus: 1.0
        },
        {
          id: 110,
          title: "Treasure Chest",
          description: "A chest full of gold! Increases all stats a little.",
          icon: "static/icons/imgi_11_shop_armoire.gif",
          price: 100,
          bonuses: { str: 3, int: 3, con: 3, per: 3 },
          stats: { str: 3, int: 3, con: 3, per: 3 },
          classBonus: 2.0
        }
      ]
    };

    let editingHabitId = null;
    let editingDailyId = null;
    let editingTodoId = null;
    let editingRewardId = null;
    let viewingSpecialRewardId = null;

    // Initialize game
    function initGame() {
      updateDisplay();
    }

    // Update all displays
    function updateDisplay() {
      gameState.xp = Math.max(0, Math.min(gameState.xp, gameState.maxXp));
gameState.hp = Math.max(0, Math.min(gameState.hp, gameState.maxHp));
      // Update XP bar
      const xpPercent = (gameState.xp / gameState.maxXp) * 100;
      document.getElementById('xpBar').style.width = xpPercent + '%';
      document.getElementById('xpDisplay').textContent = `${gameState.xp} / ${gameState.maxXp}`;
      
      // Update HP bar
      const hpPercent = (gameState.hp / gameState.maxHp) * 100;
      document.getElementById('hpBar').style.width = hpPercent + '%';
      document.getElementById('hpDisplay').textContent = `${gameState.hp} / ${gameState.maxHp}`;
      
      // Update level
      document.getElementById('level').textContent = gameState.level;
      
      // Update gems and coins
      document.getElementById('gems').textContent = gameState.gems;
      document.getElementById('gemsProfile').textContent = gameState.gems;
      document.getElementById('coins').textContent = gameState.coins;
      document.getElementById('coinsProfile').textContent = gameState.coins;
    }

    // Update habit (plus/minus buttons)
    function updateHabit(habitId, action) {
      event.stopPropagation();
      
      const habit = gameState.habits.find(h => h.id === habitId);
      if (!habit) return;
      const now = Date.now();
      if (action === 'plus' && habit.positive) {
        if (habit.lastPlusClick && now - habit.lastPlusClick < 2 * 60 * 60 * 1000) {
          showNotification('You can only use this button once every 2 hours!', 'warning');
          return;
        }
        habit.lastPlusClick = now;
        gameState.xp += 10;
        gameState.coins += 5;
        showNotification('+10 XP, +5 coins!', 'success');
      } else if (action === 'minus' && habit.negative) {
        if (habit.lastMinusClick && now - habit.lastMinusClick < 2 * 60 * 60 * 1000) {
          showNotification('You can only use this button once every 2 hours!', 'warning');
          return;
        }
        habit.lastMinusClick = now;
        gameState.hp = Math.max(0, gameState.hp - 5);
        showNotification('-5 HP', 'warning');
      }

      // Check for level up
      if (gameState.xp >= gameState.maxXp) {
        gameState.level++;
        gameState.xp = 0;
        gameState.maxXp = Math.floor(gameState.maxXp * 1.2);
        gameState.maxHp += 10;
        gameState.hp = gameState.maxHp;
        gameState.gems += 1;
        showNotification(`Level up! You're now level ${gameState.level}!`, 'success');
      }

      updateDisplay();
      
      // Save to Firebase
      const user = firebase.auth().currentUser;
      if (user) {
        saveUserGameData(user.uid);
      }
    }

    // Show notification
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#00b894' : '#e17055'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        z-index: 10001;
        animation: slideIn 0.3s ease;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }

    // Modal functions
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
      if (modalId === 'habitModal') {
        editingHabitId = null;
        document.getElementById('habitForm').reset();
      } else if (modalId === 'dailyModal') {
        editingDailyId = null;
        document.getElementById('dailyForm').reset();
      } else if (modalId === 'todoModal') {
        editingTodoId = null;
        document.getElementById('todoForm').reset();
      } else if (modalId === 'rewardModal') {
        editingRewardId = null;
        document.getElementById('rewardForm').reset();
      } else if (modalId === 'specialRewardModal') {
        viewingSpecialRewardId = null;
        document.getElementById('specialRewardIcon').src = '';
        document.getElementById('specialRewardTitle').textContent = '';
        document.getElementById('specialRewardDesc').textContent = '';
        document.getElementById('specialRewardPrice').textContent = '';
        document.getElementById('specialRewardStr').textContent = '';
        document.getElementById('specialRewardInt').textContent = '';
        document.getElementById('specialRewardCon').textContent = '';
        document.getElementById('specialRewardPer').textContent = '';
      }
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    // Habit modal functions
    function openHabitModal(habitId = null) {
      editingHabitId = habitId;
      const form = document.getElementById('habitForm');
      
      if (habitId) {
        // Edit existing habit
        const habit = gameState.habits.find(h => h.id === habitId);
        if (habit) {
          document.getElementById('habitTitle').value = habit.title;
          document.getElementById('habitNotes').value = habit.notes;
          document.getElementById('habitDifficulty').value = habit.difficulty;
          document.getElementById('habitTags').value = habit.tags;
          document.getElementById('positiveHabit').checked = habit.positive;
          document.getElementById('negativeHabit').checked = habit.negative;
        }
      } else {
        // New habit
        form.reset();
        document.getElementById('habitTitle').value = '';
        document.getElementById('habitNotes').value = '';
        document.getElementById('habitDifficulty').value = 'medium';
        document.getElementById('habitTags').value = '';
        document.getElementById('positiveHabit').checked = true;
        document.getElementById('negativeHabit').checked = false;
      }
      
      openModal('habitModal');
    }

    // Save habit
    document.getElementById('habitForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const habitData = {
        title: formData.get('title'),
        notes: formData.get('notes'),
        difficulty: formData.get('difficulty'),
        tags: formData.get('tags'),
        positive: formData.get('positive') === 'on',
        negative: formData.get('negative') === 'on'
      };

      if (editingHabitId) {
        // Update existing habit
        const habitIndex = gameState.habits.findIndex(h => h.id === editingHabitId);
        if (habitIndex !== -1) {
          gameState.habits[habitIndex] = { ...gameState.habits[habitIndex], ...habitData };
          updateHabitsList();
        }
      } else {
        // Add new habit
        const newHabit = {
          id: Date.now(),
          ...habitData
        };
        gameState.habits.push(newHabit);
        updateHabitsList();
      }

      closeModal('habitModal');
      showNotification('Habit saved successfully!', 'success');
      
      // Save to Firebase
      const user = firebase.auth().currentUser;
      if (user) {
        saveUserGameData(user.uid);
      }
    });

    // Delete habit
    function deleteHabit() {
      if (!editingHabitId) return;
      
      if (confirm('Are you sure you want to delete this habit?')) {
        gameState.habits = gameState.habits.filter(h => h.id !== editingHabitId);
        updateHabitsList();
        closeModal('habitModal');
        showNotification('Habit deleted successfully!', 'success');
        
        // Save to Firebase
        const user = firebase.auth().currentUser;
        if (user) {
          saveUserGameData(user.uid);
        }
      }
    }

    // Update habits list display
    function updateHabitsList() {
      const habitsList = document.getElementById('habitsList');
      habitsList.innerHTML = '';
      let filtered = gameState.habits;
      if (currentHabitsTab === 'weak') {
        filtered = gameState.habits.filter(h => h.difficulty === 'trivial' || h.difficulty === 'easy');
      } else if (currentHabitsTab === 'strong') {
        filtered = gameState.habits.filter(h => h.difficulty === 'medium' || h.difficulty === 'hard');
      }
      if (filtered.length === 0) {
        habitsList.innerHTML = '<div class="empty-state">No habits yet</div>';
        return;
      }
      filtered.forEach(habit => {
        const habitCard = document.createElement('div');
        habitCard.className = `task-card ${habit.negative ? 'negative' : ''}`;
        habitCard.setAttribute('data-id', habit.id);
        habitCard.innerHTML = `
          <div onclick="openHabitModal(${habit.id})">
            <div class="task-title">${habit.title}</div>
            <div class="task-desc">${habit.notes || 'No notes'}</div>
          </div>
          <div class="habit-buttons">
            ${habit.positive ? `<button class="habit-btn plus" onclick="updateHabit(${habit.id}, 'plus')" title="Good habit (+XP)">+</button>` : ''}
            ${habit.negative ? `<button class="habit-btn minus" onclick="updateHabit(${habit.id}, 'minus')" title="Bad habit (-HP)"></button>` : ''}
          </div>
        `;
        habitsList.appendChild(habitCard);
      });
    }

    // Party modal event listeners
    document.getElementById('openPartyModal').addEventListener('click', function(e) {
      e.preventDefault();
      openModal('partyModal');
    });

    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeModal('partyModal');
        closeModal('habitModal');
        closeModal('dailyModal');
        closeModal('todoModal');
        closeModal('rewardModal');
        closeModal('specialRewardModal');
      }
    });

    // Close modals by clicking outside
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', function(e) {
        if (e.target === this) {
          closeModal(this.id);
        }
      });
    });

    // Add CSS animations for notifications
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    // Dailies logic
    function updateDailiesList() {
      const dailiesList = document.getElementById('dailiesList');
      dailiesList.innerHTML = '';
      let filtered = gameState.dailies;
      if (currentDailiesTab === 'current') {
        filtered = gameState.dailies.filter(d => !d.completed);
      } else if (currentDailiesTab === 'other') {
        filtered = gameState.dailies.filter(d => d.completed);
      } // 'all'  
      if (filtered.length === 0) {
        dailiesList.innerHTML = '<div class="empty-state">No dailies yet</div>';
        return;
      }
      filtered.forEach(daily => {
        const dailyCard = document.createElement('div');
        dailyCard.className = 'task-card';
        dailyCard.setAttribute('data-id', daily.id);
        dailyCard.innerHTML = `
          <input type="checkbox" class="daily-checkbox" ${daily.completed ? 'checked disabled' : ''} onclick="toggleDailyComplete(${daily.id}, event)">
          <div style="flex:1;cursor:pointer;" onclick="openDailyModal(${daily.id})">
            <div class="task-title">${daily.title}</div>
            <div class="task-desc">${daily.notes || ''}</div>
          </div>
          <div class="task-actions">
            <button class="icon-btn" title="Edit" onclick="openDailyModal(${daily.id}, event)"><i class="fa-solid fa-pen"></i></button>
            <button class="icon-btn" title="Delete" onclick="deleteDaily(${daily.id}, event)"><i class="fa-solid fa-trash"></i></button>
          </div>
        `;
        dailiesList.appendChild(dailyCard);
      });
    }

    function toggleDailyComplete(dailyId, e) {
      e.stopPropagation();
      const daily = gameState.dailies.find(d => d.id === dailyId);
      if (!daily) return;
      if (daily.completed) return; //  
      daily.completed = true;
      gameState.xp += 15;
      gameState.coins += 7;
      showNotification('+15 XP, +7 coins!', 'success');
      updateDailiesList();
      updateDisplay();
      
      // Save to Firebase
      const user = firebase.auth().currentUser;
      if (user) {
        saveUserGameData(user.uid);
      }
    }

    function openDailyModal(dailyId = null, e) {
      if (e) e.stopPropagation();
      editingDailyId = dailyId;
      const form = document.getElementById('dailyForm');
      if (dailyId) {
        const daily = gameState.dailies.find(d => d.id === dailyId);
        if (daily) {
          document.getElementById('dailyTitle').value = daily.title;
          document.getElementById('dailyNotes').value = daily.notes;
          document.getElementById('dailyDifficulty').value = daily.difficulty;
          document.getElementById('dailyTags').value = daily.tags;
        }
      } else {
        form.reset();
        document.getElementById('dailyTitle').value = '';
        document.getElementById('dailyNotes').value = '';
        document.getElementById('dailyDifficulty').value = 'medium';
        document.getElementById('dailyTags').value = '';
      }
      openModal('dailyModal');
    }

    document.getElementById('dailyForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const dailyData = {
        title: formData.get('title'),
        notes: formData.get('notes'),
        difficulty: formData.get('difficulty'),
        tags: formData.get('tags'),
        completed: false
      };
      if (editingDailyId) {
        const dailyIndex = gameState.dailies.findIndex(d => d.id === editingDailyId);
        if (dailyIndex !== -1) {
          gameState.dailies[dailyIndex] = { ...gameState.dailies[dailyIndex], ...dailyData };
          updateDailiesList();
        }
      } else {
        const newDaily = {
          id: Date.now(),
          ...dailyData
        };
        gameState.dailies.push(newDaily);
        updateDailiesList();
      }
      closeModal('dailyModal');
      showNotification('Daily saved successfully!', 'success');
      
      // Save to Firebase
      const user = firebase.auth().currentUser;
      if (user) {
        saveUserGameData(user.uid);
      }
    });

    function deleteDaily(dailyId, e) {
      if (e) e.stopPropagation();
      if (confirm('Are you sure you want to delete this daily?')) {
        gameState.dailies = gameState.dailies.filter(d => d.id !== dailyId);
        updateDailiesList();
        closeModal('dailyModal');
        showNotification('Daily deleted successfully!', 'success');
        
        // Save to Firebase
        const user = firebase.auth().currentUser;
        if (user) {
          saveUserGameData(user.uid);
        }
      }
    }

    // To-Dos logic
    function updateTodosList() {
      const todosList = document.getElementById('todosList');
      todosList.innerHTML = '';
      let filtered = gameState.todos;
      if (currentTodosTab === 'active') {
        filtered = gameState.todos.filter(t => !t.completed);
      } else if (currentTodosTab === 'done') {
        filtered = gameState.todos.filter(t => t.completed);
      } else if (currentTodosTab === 'dated') {
        filtered = gameState.todos.filter(t => t.date); //    date
      }
      if (filtered.length === 0) {
        todosList.innerHTML = '<div class="empty-state">No to-dos yet</div>';
        return;
      }
      filtered.forEach(todo => {
        const todoCard = document.createElement('div');
        todoCard.className = 'task-card';
        todoCard.setAttribute('data-id', todo.id);
        todoCard.innerHTML = `
          <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked disabled' : ''} onclick="toggleTodoComplete(${todo.id}, event)">
          <div style="flex:1;cursor:pointer;" onclick="openTodoModal(${todo.id})">
            <div class="task-title">${todo.title}</div>
            <div class="task-desc">${todo.notes || ''}</div>
          </div>
          <div class="task-actions">
            <button class="icon-btn" title="Edit" onclick="openTodoModal(${todo.id}, event)"><i class="fa-solid fa-pen"></i></button>
            <button class="icon-btn" title="Delete" onclick="deleteTodo(${todo.id}, event)"><i class="fa-solid fa-trash"></i></button>
          </div>
        `;
        todosList.appendChild(todoCard);
      });
    }

    function toggleTodoComplete(todoId, e) {
      e.stopPropagation();
      const todo = gameState.todos.find(t => t.id === todoId);
      if (!todo || todo.completed) return; //   ,   
      todo.completed = true;
      gameState.xp += 20;
      gameState.coins += 10;
      showNotification('+20 XP, +10 coins!', 'success');
      updateDisplay();
      updateTodosList();
      // Save to Firebase
      const user = firebase.auth().currentUser;
      if (user) {
        saveUserGameData(user.uid);
      }
    }

    function openTodoModal(todoId = null, e) {
      if (e) e.stopPropagation();
      editingTodoId = todoId;
      const form = document.getElementById('todoForm');
      if (todoId) {
        const todo = gameState.todos.find(t => t.id === todoId);
        if (todo) {
          document.getElementById('todoTitle').value = todo.title;
          document.getElementById('todoNotes').value = todo.notes;
          document.getElementById('todoDifficulty').value = todo.difficulty;
          document.getElementById('todoTags').value = todo.tags;
        }
      } else {
        form.reset();
        document.getElementById('todoTitle').value = '';
        document.getElementById('todoNotes').value = '';
        document.getElementById('todoDifficulty').value = 'medium';
        document.getElementById('todoTags').value = '';
      }
      openModal('todoModal');
    }

    document.getElementById('todoForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const todoData = {
        title: formData.get('title'),
        notes: formData.get('notes'),
        difficulty: formData.get('difficulty'),
        tags: formData.get('tags'),
        completed: false
      };
      if (editingTodoId) {
        const todoIndex = gameState.todos.findIndex(t => t.id === editingTodoId);
        if (todoIndex !== -1) {
          gameState.todos[todoIndex] = { ...gameState.todos[todoIndex], ...todoData };
          updateTodosList();
        }
      } else {
        const newTodo = {
          id: Date.now(),
          ...todoData
        };
        gameState.todos.push(newTodo);
        updateTodosList();
      }
      closeModal('todoModal');
      showNotification('To-Do saved successfully!', 'success');
      
      // Save to Firebase
      const user = firebase.auth().currentUser;
      if (user) {
        saveUserGameData(user.uid);
      }
    });

    function deleteTodo(todoId, e) {
      if (e) e.stopPropagation();
      if (confirm('Are you sure you want to delete this to-do?')) {
        gameState.todos = gameState.todos.filter(t => t.id !== todoId);
        updateTodosList();
        closeModal('todoModal');
        showNotification('To-Do deleted successfully!', 'success');
        
        // Save to Firebase
        const user = firebase.auth().currentUser;
        if (user) {
          saveUserGameData(user.uid);
        }
      }
    }

    // Rewards logic
    function updateRewardsList() {
      const rewardsList = document.getElementById('rewardsList');
      rewardsList.innerHTML = '';
      if (gameState.rewards.length === 0) {
        rewardsList.innerHTML = '<div class="empty-state">No rewards yet</div>';
      }
      gameState.rewards.forEach(reward => {
        const rewardCard = document.createElement('div');
        rewardCard.className = 'reward-card';
        rewardCard.setAttribute('data-id', reward.id);
        rewardCard.innerHTML = `
          <div class="reward-icon"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
          <div>${reward.title}</div>
          <div class="reward-cost"><i class="fa-solid fa-coins"></i> ${reward.price}</div>
          <div class="task-actions">
            <button class="icon-btn" title="Edit" onclick="openRewardModal(${reward.id}, event)"><i class="fa-solid fa-pen"></i></button>
            <button class="icon-btn" title="Delete" onclick="deleteReward(${reward.id}, event)"><i class="fa-solid fa-trash"></i></button>
            <button class="icon-btn" title="Buy" onclick="buyReward(${reward.id}, event)"><i class="fa-solid fa-cart-shopping"></i></button>
          </div>
        `;
        rewardsList.appendChild(rewardCard);
      });
    }

    function openRewardModal(rewardId = null, e) {
      if (e) e.stopPropagation();
      editingRewardId = rewardId;
      const form = document.getElementById('rewardForm');
      if (rewardId) {
        const reward = gameState.rewards.find(r => r.id === rewardId);
        if (reward) {
          document.getElementById('rewardTitle').value = reward.title;
          document.getElementById('rewardNotes').value = reward.notes;
          document.getElementById('rewardPrice').value = reward.price;
          document.getElementById('rewardTags').value = reward.tags;
        }
      } else {
        form.reset();
        document.getElementById('rewardTitle').value = '';
        document.getElementById('rewardNotes').value = '';
        document.getElementById('rewardPrice').value = 10;
        document.getElementById('rewardTags').value = '';
      }
      openModal('rewardModal');
    }

    document.getElementById('rewardForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const rewardData = {
        title: formData.get('title'),
        notes: formData.get('notes'),
        price: parseInt(formData.get('price'), 10),
        tags: formData.get('tags')
      };
      if (editingRewardId) {
        const rewardIndex = gameState.rewards.findIndex(r => r.id === editingRewardId);
        if (rewardIndex !== -1) {
          gameState.rewards[rewardIndex] = { ...gameState.rewards[rewardIndex], ...rewardData };
          updateRewardsList();
        }
      } else {
        const newReward = {
          id: Date.now(),
          ...rewardData
        };
        gameState.rewards.push(newReward);
        updateRewardsList();
      }
      closeModal('rewardModal');
      showNotification('Reward saved successfully!', 'success');
      
      // Save to Firebase
      const user = firebase.auth().currentUser;
      if (user) {
        saveUserGameData(user.uid);
      }
    });

    function deleteReward(rewardId, e) {
      if (e) e.stopPropagation();
      if (confirm('Are you sure you want to delete this reward?')) {
        gameState.rewards = gameState.rewards.filter(r => r.id !== rewardId);
        updateRewardsList();
        closeModal('rewardModal');
        showNotification('Reward deleted successfully!', 'success');
      }
    }

    function buyReward(rewardId, e) {
      if (e) e.stopPropagation();
      const reward = gameState.rewards.find(r => r.id === rewardId);
      if (!reward) return;
      if (gameState.coins >= reward.price) {
        gameState.coins -= reward.price;
        showNotification('Reward purchased!', 'success');
        updateDisplay();
        
        // Save to Firebase
        const user = firebase.auth().currentUser;
        if (user) {
          saveUserGameData(user.uid);
        }
      } else {
        showNotification('Not enough coins!', 'warning');
      }
    }

    // Special rewards (visual/items)
    function updateSpecialRewardsList() {
      const specialList = document.getElementById('specialRewardsList');
      specialList.innerHTML = '';
      gameState.specialRewards.forEach(item => {
        const card = document.createElement('div');
        card.className = 'reward-card';
        card.innerHTML = `
          <div class="reward-icon"><img src="${item.icon}" alt="${item.title}" style="width:40px;height:40px;"></div>
          <div>${item.title}</div>
          <div class="reward-cost"><i class="fa-solid fa-coins"></i> ${item.price}</div>
        `;
        card.onclick = () => openSpecialRewardModal(item.id);
        specialList.appendChild(card);
      });
    }

    function openSpecialRewardModal(itemId) {
      viewingSpecialRewardId = itemId;
      const item = gameState.specialRewards.find(i => i.id === itemId);
      if (!item) return;
      document.getElementById('specialRewardTitle').textContent = item.title;
      document.getElementById('specialRewardDesc').textContent = item.description;
      document.getElementById('specialRewardIcon').src = item.icon;
      document.getElementById('specialRewardPrice').textContent = item.price;
      document.getElementById('specialRewardStr').textContent = item.bonuses.str;
      document.getElementById('specialRewardInt').textContent = item.bonuses.int;
      document.getElementById('specialRewardCon').textContent = item.bonuses.con;
      document.getElementById('specialRewardPer').textContent = item.bonuses.per;
      document.getElementById('specialRewardModal').classList.add('active');
    }

    function buySpecialReward() {
      const item = gameState.specialRewards.find(i => i.id === viewingSpecialRewardId);
      if (!item) return;
      if (gameState.coins >= item.price) {
        gameState.coins -= item.price;
        //     (,  )
        // ...
        showNotification('Item purchased! Bonuses applied.', 'success');
        updateDisplay();
        closeModal('specialRewardModal');
        
        // Save to Firebase
        const user = firebase.auth().currentUser;
        if (user) {
          saveUserGameData(user.uid);
        }
      } else {
        showNotification('Not enough coins!', 'warning');
      }
    }

    // Initialize the game when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Game will be initialized after authentication check
      //  partyModal   Start
      var startBtn = document.querySelector('.cta-btn');
      if(startBtn) {
        startBtn.addEventListener('click', function() {
          openModal('partyModal');
        });
      }
      // Ensure lists show default data before auth callback fires
      updateHabitsList();
      updateDailiesList();
      updateTodosList();
      updateRewardsList();
      updateSpecialRewardsList();
    });

    let currentRewardsTab = 'all';
    function switchRewardsTab(tab) {
      currentRewardsTab = tab;
      document.getElementById('tabAll').classList.remove('active');
      document.getElementById('tabSeasonal').classList.remove('active');
      document.getElementById('tabDelayed').classList.remove('active');
      if(tab==='all') document.getElementById('tabAll').classList.add('active');
      if(tab==='seasonal') document.getElementById('tabSeasonal').classList.add('active');
      if(tab==='delayed') document.getElementById('tabDelayed').classList.add('active');
      updateRewardsList();
      updateSpecialRewardsList();
    }
    function quickAddReward() {
      const input = document.getElementById('addRewardInput');
      const value = input.value.trim();
      if(value) {
        gameState.rewards.push({ id: Date.now(), title: value, notes: '', price: 10, tags: '' });
        input.value = '';
        updateRewardsList();
      }
    }
    // ...
    //  updateRewardsList  updateSpecialRewardsList    currentRewardsTab
    //  specialRewards   .reward-dot
  </script>
  <script>
    let currentHabitsTab = 'all';
    function switchHabitsTab(tab) {
      currentHabitsTab = tab;
      document.getElementById('tabHabitsAll').classList.remove('active');
      document.getElementById('tabHabitsWeak').classList.remove('active');
      document.getElementById('tabHabitsStrong').classList.remove('active');
      if(tab==='all') document.getElementById('tabHabitsAll').classList.add('active');
      if(tab==='weak') document.getElementById('tabHabitsWeak').classList.add('active');
      if(tab==='strong') document.getElementById('tabHabitsStrong').classList.add('active');
      updateHabitsList();
    }
    //  updateHabitsList    currentHabitsTab
  </script>
  <script>
    let currentDailiesTab = 'all';
    function switchDailiesTab(tab) {
      currentDailiesTab = tab;
      document.getElementById('tabDailiesAll').classList.remove('active');
      document.getElementById('tabDailiesCurrent').classList.remove('active');
      document.getElementById('tabDailiesOther').classList.remove('active');
      if(tab==='all') document.getElementById('tabDailiesAll').classList.add('active');
      if(tab==='current') document.getElementById('tabDailiesCurrent').classList.add('active');
      if(tab==='other') document.getElementById('tabDailiesOther').classList.add('active');
      updateDailiesList();
    }
    //  updateDailiesList    currentDailiesTab
  </script>
  <script>
    let currentTodosTab = 'active';
    function switchTodosTab(tab) {
      currentTodosTab = tab;
      document.getElementById('tabTodosActive').classList.remove('active');
      document.getElementById('tabTodosDated').classList.remove('active');
      document.getElementById('tabTodosDone').classList.remove('active');
      if(tab==='active') document.getElementById('tabTodosActive').classList.add('active');
      if(tab==='dated') document.getElementById('tabTodosDated').classList.add('active');
      if(tab==='done') document.getElementById('tabTodosDone').classList.add('active');
      updateTodosList();
    }
    //  updateTodosList    currentTodosTab
  </script>
  
  <!-- Firebase Authentication Script -->
  <script>
    // Check authentication state
    let redirecting = false;
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        // User is signed in
        console.log('User authenticated:', user.email, 'UID:', user.uid);
        updateUserDisplay(user);
        
        // Load user data from Firebase
        if (user.uid) {
          loadUserGameData(user.uid);
        } else {
          console.error('No user UID available');
          // Initialize with default values
          initGame();
          updateHabitsList();
          updateDailiesList();
          updateTodosList();
          updateRewardsList();
          updateSpecialRewardsList();
        }
      } else {
        // User is signed out - show guest mode or login prompt
        console.log('User is signed out - showing guest mode');
        updateUserDisplay(null);
        
        // Initialize with default values for guest mode
        initGame();
        updateHabitsList();
        updateDailiesList();
        updateTodosList();
        updateRewardsList();
        updateSpecialRewardsList();
      }
    });

    // Update user display
    function updateUserDisplay(user) {
  const displayNameElement = document.getElementById('userDisplayName');
  const userEmailElement = document.getElementById('userEmail');
  const sidebarAvatar = document.getElementById('sidebarAvatar');

  if (user) {
    const displayName = user.displayName || 'Guest';
    const email = user.email || 'guest@habitica.com';
    const photoURL = user.photoURL || null;

    displayNameElement.textContent = displayName;
    userEmailElement.textContent = email;

    //  
    if (photoURL) {
      sidebarAvatar.innerHTML = `<img src="${photoURL}" alt="Avatar" style="width:72px;height:72px;border-radius:50%;object-fit:cover;">`;
    } else {
      sidebarAvatar.innerHTML = `<i class="fa-solid fa-user"></i>`;
    }
  } else {
    displayNameElement.textContent = 'Guest';
    userEmailElement.textContent = 'guest@habitica.com';
    sidebarAvatar.innerHTML = `<i class="fa-solid fa-user"></i>`;
  }
}

    // Sign out function
    function signOut() {
      // Set a flag to prevent auto-login
      localStorage.setItem('manualSignOut', 'true');
      
      firebase.auth().signOut().then(() => {
        console.log('User signed out successfully');
        
        // Clear any cached user data
        localStorage.removeItem('userData');
        sessionStorage.clear();
        
        // Force redirect to signin page
        window.location.replace('signin.html');
      }).catch((error) => {
        console.error('Sign out error:', error);
        // Even if there's an error, try to redirect
        window.location.replace('signin.html');
      });
    }

    // Add sign out button to header actions
    document.addEventListener('DOMContentLoaded', function() {
      const headerActions = document.querySelector('.header-actions');
      if (headerActions) {
        // Add sign out button
        const signOutBtn = document.createElement('button');
        signOutBtn.className = 'icon-btn';
        signOutBtn.innerHTML = '<i class="fa-solid fa-sign-out-alt"></i>';
        signOutBtn.title = 'Sign Out';
        signOutBtn.onclick = signOut;
        headerActions.appendChild(signOutBtn);
      }
    });

    // Firebase Database Functions
    function saveUserGameData(userId) {
      if (!userId || !firestore) return;
      
      const userData = {
        gameState: {
          xp: gameState.xp,
          maxXp: gameState.maxXp,
          hp: gameState.hp,
          maxHp: gameState.maxHp,
          level: gameState.level,
          gems: gameState.gems,
          coins: gameState.coins
        },
        habits: gameState.habits,
        dailies: gameState.dailies,
        todos: gameState.todos,
        rewards: gameState.rewards,
        lastUpdated: Date.now()
      };

      return firestore.collection('users').doc(userId).set(userData)
        .then(() => {
          console.log('Game data saved successfully');
        })
        .catch((error) => {
          console.error('Error saving game data:', error);
        });
    }

    function loadUserGameData(userId) {
      if (!userId || !firestore) {
        console.log('No user ID provided, using default values');
        initGame();
        updateHabitsList();
        updateDailiesList();
        updateTodosList();
        updateRewardsList();
        updateSpecialRewardsList();
        return;
      }
      
      console.log('Loading user data for:', userId);
      
      return firestore.collection('users').doc(userId).get()
        .then((doc) => {
          const data = doc.exists ? doc.data() : null;
          if (data) {
            console.log('User data found:', data);
            
            // Load game state
            if (data.gameState) {
              gameState.xp = data.gameState.xp || 50;
              gameState.maxXp = data.gameState.maxXp || 100;
              gameState.hp = data.gameState.hp || 50;
              gameState.maxHp = data.gameState.maxHp || 50;
              gameState.level = data.gameState.level || 1;
              gameState.gems = data.gameState.gems || 0;
              gameState.coins = data.gameState.coins || 0;
            }
            
            // Load tasks
            if (data.habits) gameState.habits = data.habits;
            if (data.dailies) gameState.dailies = data.dailies;
            if (data.todos) gameState.todos = data.todos;
            if (data.rewards) gameState.rewards = data.rewards;
            
            console.log('Game data loaded successfully');
          } else {
            console.log('No saved data found for user, using defaults');
          }
          
          // Always initialize game after loading (or not loading) data
          initGame();
          updateHabitsList();
          updateDailiesList();
          updateTodosList();
          updateRewardsList();
          updateSpecialRewardsList();
        })
        .catch((error) => {
          console.error('Error loading game data:', error);
          console.log('Using default values due to error');
          
          // Initialize with default values on error
          initGame();
          updateHabitsList();
          updateDailiesList();
          updateTodosList();
          updateRewardsList();
          updateSpecialRewardsList();
        });
    }

    // Auto-save function
    function autoSaveGameData() {
      const user = firebase.auth().currentUser;
      if (user) {
        saveUserGameData(user.uid);
      }
    }

    // Set up auto-save every 30 seconds
    setInterval(autoSaveGameData, 30000);
  </script>
<!-- Profile Edit Modal -->
<!-- Profile Edit Modal -->
<div class="modal-overlay" id="profileModal" style="display:none;">
  <div class="profile-modal">
    <button class="close-btn" onclick="closeProfileModal()" title="Close">&times;</button>
    <div class="modal-content">
      <div class="modal-title">
        <i class="fa-solid fa-pen" style="color:#6c5ce7;margin-right:8px;"></i>
        Edit Profile
      </div>
      <form id="profileForm" onsubmit="saveProfile(event)">
        <div class="form-group avatar-group">
          <label for="profileAvatar" class="avatar-label">
            <img id="profileAvatarPreview" src="https://www.gravatar.com/avatar/?d=mp" alt="Avatar" class="profile-avatar">
            <span class="avatar-edit">Change</span>
          </label>
          <input type="file" id="profileAvatar" accept="image/*" style="display:none;">
        </div>
        <div class="form-group">
          <label for="profileDisplayName">Nickname</label>
          <input type="text" id="profileDisplayName" required>
        </div>
        <div class="form-group">
          <label for="profileEmail">Email</label>
          <input type="email" id="profileEmail" disabled>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeProfileModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
function openProfileModal() {
  const user = firebase.auth().currentUser;
  if (!user) return;
  document.getElementById('profileDisplayName').value = user.displayName || '';
  document.getElementById('profileEmail').value = user.email || '';
  document.getElementById('profileAvatarPreview').src = user.photoURL || 'https://www.gravatar.com/avatar/?d=mp';
  document.getElementById('profileModal').style.display = 'flex';
  document.getElementById('profileAvatar').value = '';
}
function closeProfileModal() {
  document.getElementById('profileModal').style.display = 'none';
}
document.getElementById('profileAvatar').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(ev) {
      document.getElementById('profileAvatarPreview').src = ev.target.result;
    };
    reader.readAsDataURL(file);
  }
});
async function saveProfile(e) {
  e.preventDefault();
  const user = firebase.auth().currentUser;
  if (!user) return;
  const displayName = document.getElementById('profileDisplayName').value;
  let photoURL = user.photoURL;
  const fileInput = document.getElementById('profileAvatar');
  const file = fileInput.files[0];
  if (file) {
    const storageRef = firebase.storage().ref();
    const avatarRef = storageRef.child('avatars/' + user.uid + '_' + Date.now());
    await avatarRef.put(file);
    photoURL = await avatarRef.getDownloadURL();
  }
  //   
  await user.updateProfile({ displayName, photoURL });
  //   Firestore
  if (window.firestore) {
    await firestore.collection('users').doc(user.uid).set({
      displayName,
      photoURL,
      email: user.email
    }, { merge: true });
  }
  showNotification('Profile updated!', 'success');
  closeProfileModal();
  updateUserDisplay(user);
}
document.addEventListener('DOMContentLoaded', function() {
  const headerActions = document.querySelector('.header-actions');
  if (headerActions) {
    const settingsBtn = headerActions.querySelector('.fa-cog').parentElement;
    settingsBtn.onclick = openProfileModal;
  }
});
</script>
</body>
</html>